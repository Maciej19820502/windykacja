{% extends "base.html" %}
{% block title %}Procedura windykacji - Windykacja{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-diagram-3 me-2"></i>Procedura windykacji</h2>
    <form method="POST" action="{{ url_for('procedura_reset') }}" onsubmit="return confirm('Przywrócić wszystkie szablony do wartości domyślnych? Zmiany zostaną utracone.')">
        <button type="submit" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-counterclockwise me-1"></i>Przywróć domyślne
        </button>
    </form>
</div>

<!-- Opis ogólny -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Zasady komunikacji</h5>
        <div class="row">
            <div class="col-md-6">
                <h6><i class="bi bi-envelope me-1"></i>E-mail</h6>
                <ul class="small mb-3">
                    <li><strong>Etap 1</strong> – korespondencja generowana indywidualnie per faktura.</li>
                    <li><strong>Etapy 2–5</strong> – o przejściu decyduje najstarszy rozrachunek; poniżej treści tabela zbiorcza zobowiązań (przeterminowane od najstarszego + nieprzeterminowane).</li>
                    <li>Treść zawiera pełne dane nadawcy (nazwa, adres, NIP) oraz dane odbiorcy.</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6><i class="bi bi-phone me-1"></i>SMS</h6>
                <ul class="small mb-3">
                    <li><strong>Etap 1</strong> – wiadomość generowana indywidualnie per faktura.</li>
                    <li><strong>Etapy 2–5</strong> – o przejściu decyduje najstarszy rozrachunek; w treści łączna wartość rozrachunków + kwota przeterminowana.</li>
                </ul>
            </div>
        </div>
        <div class="small text-muted">
            <strong>Warianty intensywności:</strong>
            <span class="badge bg-info text-dark">LEKKA</span>
            <span class="badge bg-primary">STANDARDOWA</span>
            <span class="badge bg-danger">OSTRA</span>
            <span class="badge bg-secondary">BRAK</span>
            – obowiązują dla każdego etapu. Wariant przypisany jest do kontrahenta.
            Waluta zobowiązania jest zawsze podawana; zobowiązania wielowalutowe prezentowane z rozbiciem na waluty.
        </div>
    </div>
</div>

<!-- Etapy -->
<div class="row g-4">
    {% for e in etapy %}
    <div class="col-12">
        <div class="card border-{{ e.info.kolor }}">
            <div class="card-body d-flex align-items-center">
                <div class="me-4 text-center" style="min-width: 60px;">
                    <div class="rounded-circle bg-{{ e.info.kolor }} {{ 'text-white' if e.info.kolor != 'warning' else 'text-dark' }} d-inline-flex align-items-center justify-content-center" style="width: 50px; height: 50px; font-size: 1.3rem;">
                        <i class="bi {{ e.info.ikona }}"></i>
                    </div>
                    <div class="small fw-bold mt-1">Etap {{ e.nr }}</div>
                </div>
                <div class="flex-grow-1">
                    <h5 class="card-title mb-1">{{ e.info.nazwa }}</h5>
                    <p class="card-text text-muted small mb-0">{{ e.info.opis }}</p>
                </div>
                <div class="text-end ms-3">
                    <div class="mb-2">
                        <span class="badge bg-success">{{ e.szablony_count }}/{{ e.szablony_total }}</span>
                        <small class="text-muted ms-1">szablonów</small>
                    </div>
                    <a href="{{ url_for('procedura_etap', etap=e.nr) }}" class="btn btn-outline-{{ e.info.kolor }} btn-sm">
                        <i class="bi bi-pencil-square me-1"></i>Edytuj szablony
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Zmienne dostępne w szablonach -->
<div class="card mt-4">
    <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-braces me-1"></i>Zmienne dostępne w szablonach</h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <h6 class="small fw-bold">Faktura</h6>
                <code class="small d-block">{nr_faktury}</code>
                <code class="small d-block">{kwota}</code>
                <code class="small d-block">{waluta}</code>
                <code class="small d-block">{data_wystawienia}</code>
                <code class="small d-block">{termin_platnosci}</code>
            </div>
            <div class="col-md-4">
                <h6 class="small fw-bold">Kontrahent</h6>
                <code class="small d-block">{kontrahent_nazwa}</code>
                <code class="small d-block">{kontrahent_adres}</code>
                <code class="small d-block">{kontrahent_nip}</code>
            </div>
            <div class="col-md-4">
                <h6 class="small fw-bold">Firma / Zbiorcze</h6>
                <code class="small d-block">{firma_nazwa}</code>
                <code class="small d-block">{firma_adres}</code>
                <code class="small d-block">{firma_nip}</code>
                <code class="small d-block">{firma_osoba}</code>
                <code class="small d-block">{suma_zobowiazan}</code>
                <code class="small d-block">{suma_przeterminowanych}</code>
                <code class="small d-block">{tabela_zobowiazan}</code>
            </div>
        </div>
    </div>
</div>
{% endblock %}
